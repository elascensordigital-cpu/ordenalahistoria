<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ordena la Historia</title>
  <style>
    :root{
      --navy:#061227;
      --navy2:#071a37;
      --gold:#d6b25e;
      --gold2:#f0d79a;
      --line:rgba(214,178,94,.22);
      --line2:rgba(214,178,94,.40);
      --text:rgba(240,232,210,.95);
      --muted:rgba(240,232,210,.75);
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 520px at 20% 0%, rgba(214,178,94,.10), transparent 55%),
                  radial-gradient(700px 450px at 85% 10%, rgba(214,178,94,.06), transparent 52%),
                  var(--navy);
      color:var(--text);
      min-height:100vh;
    }

    /* HOME */
    header{
      padding:14px 14px 0;
      position:relative;
      max-width:1100px;
      margin:0 auto;
    }
    .header-img{
      width:100%;
      height:auto;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      display:block;
    }
    .papyrus{
      position:absolute;
      top:24px;
      right:26px;
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(6,18,39,.55);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      font-size:22px;
      line-height:1;
    }
    .papyrus:hover{ border-color: rgba(214,178,94,.42); }

    .home-wrap{
      max-width:1100px;
      margin: 14px auto 0;
      padding: 0 14px;
      text-align:center;
    }
    .home-line{
      color: var(--muted);
      font-size: 14px;
      letter-spacing:.2px;
      user-select:none;
      margin: 0 0 14px;
    }
    .start-btn{
      width:min(520px, 100%);
      border:1px solid rgba(214,178,94,.42);
      background: linear-gradient(180deg, rgba(214,178,94,.18), rgba(6,18,39,.35));
      color: var(--gold2);
      padding: 16px 18px;
      border-radius: 22px;
      cursor:pointer;
      font-weight: 1000;
      letter-spacing: .6px;
      text-transform: uppercase;
      box-shadow: 0 16px 45px rgba(0,0,0,.55);
      font-size: 16px;
    }
    .start-btn:hover{
      border-color: rgba(214,178,94,.65);
      box-shadow: 0 18px 55px rgba(0,0,0,.62);
      transform: translateY(-1px);
    }
    .start-btn:active{ transform: translateY(0px); }

    /* GAME */
    main{
      max-width: 920px;
      margin: 18px auto 60px;
      padding: 0 14px;
      display:none;
    }
    .panel{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(7,26,55,.72), rgba(6,18,39,.60));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .who{
      font-size:14px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .who b{ color: var(--gold2); }

    .mini-actions{ display:flex; gap:10px; flex:0 0 auto; }
    .mini-btn{
      border:1px solid var(--line);
      background: rgba(6,18,39,.45);
      color: var(--text);
      padding:8px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    .mini-btn:hover{ border-color: rgba(214,178,94,.42); }
    .mini-btn:disabled{ opacity:.55; cursor:not-allowed; }

    .panel-b{ padding:14px; }
    .list{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:240px;
    }
    .card{
      border:1px solid rgba(214,178,94,.22);
      background: rgba(6,18,39,.55);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:grab;
    }
    .card:active{ cursor:grabbing; }
    .card.locked{ cursor:default; }
    .handle{
      color: rgba(214,178,94,.85);
      opacity:.95;
      width:14px;
      margin-top:2px;
      user-select:none;
      flex:0 0 auto;
    }
    .title{
      margin:0;
      font-size:14px;
      font-weight:850;
      letter-spacing:.1px;
      color: rgba(240,232,210,.96);
    }
    .meta{
      margin:4px 0 0;
      font-size: 12px;
      color: rgba(240,232,210,.72);
      min-height: 1em;
    }
    .ghost{ opacity:.50; border-style:dashed; }

    /* Compact rounds marker */
    .round{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .round-pill{
      border:1px solid rgba(214,178,94,.40);
      background: rgba(214,178,94,.10);
      color: var(--gold2);
      font-size:12px;
      font-weight:950;
      letter-spacing:.25px;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .round-bar{
      width: 86px;
      height: 8px;
      border-radius: 999px;
      border:1px solid rgba(214,178,94,.25);
      background: rgba(6,18,39,.35);
      overflow:hidden;
    }
    .round-bar-fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(214,178,94,.35), rgba(240,215,154,.75));
      border-radius:999px;
      transition: width .25s ease;
    }

    @media (max-width: 680px){
      .round-bar{ width: 62px; }
      .round-pill{ font-size: 11px; padding:6px 9px; }
    }
    @media (max-width: 520px){
      .mini-actions{ gap:8px; }
      .mini-btn{ padding:8px 9px; }
      .panel-b{ padding:12px; }
      .card{ padding:11px 11px; }
      .start-btn{ font-size: 15px; padding: 15px 16px; }
      .round-bar{ display:none; }
    }

    /* SETTINGS MODAL */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px;
      z-index:50;
    }
    .modal{
      width:min(820px, 100%);
      border-radius: 24px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(7,26,55,.96), rgba(6,18,39,.96));
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modal-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .modal-h h3{
      margin:0;
      font-size: 15px;
      letter-spacing:.25px;
      color: rgba(240,232,210,.95);
    }
    .modal-b{ padding:14px; display:grid; gap:12px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: 1fr; }
    }

    .cardset{
      border:1px solid rgba(214,178,94,.22);
      border-radius: 18px;
      padding: 12px;
      background: rgba(6,18,39,.45);
    }
    .cardset .label{
      font-size: 12px;
      color: rgba(240,232,210,.70);
      margin: 0 0 8px;
      letter-spacing:.15px;
    }

    .seg{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 420px){
      .seg{ grid-template-columns: 1fr; }
    }

    .seg button{
      border:1px solid rgba(214,178,94,.22);
      background: rgba(6,18,39,.35);
      color: rgba(240,232,210,.9);
      padding: 10px 10px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .seg button.active{
      border-color: rgba(214,178,94,.65);
      background: rgba(214,178,94,.14);
      color: var(--gold2);
    }
    .seg button:hover{ border-color: rgba(214,178,94,.42); }

    select, textarea{
      width:100%;
      border:1px solid rgba(214,178,94,.22);
      background: rgba(6,18,39,.35);
      color: rgba(240,232,210,.92);
      border-radius: 16px;
      padding: 10px 12px;
      outline:none;
    }
    textarea{ min-height: 96px; resize: vertical; }

    .modal-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* POPUP FINAL */
    .popup{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:60;
      background: rgba(0,0,0,.62);
    }
    .popup-card{
      width:min(760px, 100%);
      border-radius: 24px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(7,26,55,.96), rgba(6,18,39,.96));
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      padding: 16px;
    }
    .popup-card h4{
      margin:0 0 8px;
      font-size: 16px;
      color: var(--gold2);
      letter-spacing:.2px;
    }
    .popup-card p{
      margin: 0 0 10px;
      color: rgba(240,232,210,.85);
      line-height:1.45;
      font-size: 13.5px;
      white-space:pre-wrap;
    }
    .scores{
      border:1px solid rgba(214,178,94,.22);
      border-radius:16px;
      padding:12px;
      background: rgba(6,18,39,.45);
      color: rgba(240,232,210,.85);
      font-size:13px;
      line-height:1.4;
      white-space:pre-wrap;
      margin: 10px 0 12px;
    }
  </style>
</head>
<body>

  <header>
    <img class="header-img" src="cabecera.png" alt="Cabecera" />
    <div class="papyrus" id="btnSettings" title="Ajustes">ðŸ“œ</div>
  </header>

  <div class="home-wrap">
    <div class="home-line">Arrastra los eventos para ordenarlos del mÃ¡s antiguo â†’ mÃ¡s reciente.</div>
    <button class="start-btn" id="btnStart">Â¡ORDENEMOS LA HISTORIA!</button>
  </div>

  <main id="game">
    <section class="panel">
      <div class="panel-h">
        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
          <div class="who" id="whoLine">Turno: <b>â€”</b> Â· Pantalla <b>â€”</b></div>

          <div class="round" aria-label="Progreso">
            <span class="round-pill" id="roundPill">Ronda â€”/â€”</span>
            <div class="round-bar" aria-hidden="true">
              <div class="round-bar-fill" id="roundBarFill"></div>
            </div>
          </div>
        </div>

        <div class="mini-actions">
          <button class="mini-btn" id="btnCheck">Comprobar</button>
          <button class="mini-btn" id="btnNext" disabled>Siguiente</button>
        </div>
      </div>

      <div class="panel-b">
        <ul class="list" id="cardList"></ul>
      </div>
    </section>
  </main>

  <!-- Ajustes -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-h">
        <h3>Ajustes</h3>
        <button class="mini-btn" id="btnClose">Cerrar</button>
      </div>

      <div class="modal-b">
        <div class="grid">
          <div class="cardset">
            <div class="label">Modo</div>
            <div class="seg" role="group" aria-label="Modo">
              <button id="modeSolo" type="button">Solo</button>
              <button id="modeGroups" type="button">Grupos</button>
            </div>
          </div>

          <div class="cardset">
            <div class="label">Eventos por ronda</div>
            <select id="perScreen">
              <option>4</option>
              <option selected>5</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
            </select>
          </div>

          <div class="cardset">
            <div class="label">Rondas</div>
            <select id="rounds">
              <option>5</option>
              <option selected>8</option>
              <option>10</option>
              <option>12</option>
              <option>15</option>
              <option>20</option>
            </select>
          </div>

          <div class="cardset">
            <div class="label">Dificultad</div>
            <select id="difficulty">
              <option value="easy">FÃ¡cil</option>
              <option value="normal" selected>Normal</option>
              <option value="hard">DifÃ­cil</option>
            </select>
          </div>
        </div>

        <div class="cardset" id="groupsBox" style="display:none;">
          <div class="label">Grupos</div>
          <textarea id="groups" placeholder="Atenas&#10;Roma&#10;Sumer"></textarea>
        </div>

        <div class="modal-actions">
          <button class="mini-btn" id="btnSave" style="border-color: rgba(214,178,94,.42);">Guardar</button>
          <button class="mini-btn" id="btnReset" style="border-color: rgba(214,178,94,.22);">Reiniciar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup final -->
  <div class="popup" id="popup">
    <div class="popup-card">
      <h4 id="popupTitle">Fin</h4>
      <p id="popupText"></p>
      <div class="scores" id="popupScores" style="display:none;"></div>
      <button class="mini-btn" id="btnPopupClose">Cerrar</button>
    </div>
  </div>

  <script>
    /***********************
     * FRASES (random)
     ***********************/
    const QUOTES_KEEP_GOING = [
      { who:"Winston Churchill", text:"â€œNever give in, never give in, never, never, never, neverâ€¦â€" },
      { who:"Franklin D. Roosevelt", text:"â€œThe only thing we have to fear is fear itself.â€" },
      { who:"Theodore Roosevelt", text:"â€œIt is hard to fail, but it is worse never to have tried to succeed.â€" },
      { who:"Thomas A. Edison", text:"â€œI have not failed. I've just found 10,000 ways that won't work.â€" },
      { who:"Amelia Earhart", text:"â€œThe most difficult thing is the decision to act. The rest is merely tenacity.â€" },
      { who:"Mark Twain", text:"â€œCourage is resistance to fear, mastery of fearâ€”not absence of fear.â€" }
    ];

    const QUOTES_VICTORY = [
      { who:"Julio CÃ©sar", text:"â€œVeni, vidi, vici.â€" },
      { who:"Neil Armstrong", text:"â€œThat's one small step for man, one giant leap for mankind.â€" },
      { who:"Winston Churchill", text:"â€œThis is not the endâ€¦ but it is, perhaps, the end of the beginning.â€" },
      { who:"John F. Kennedy", text:"â€œWe choose to go to the Moonâ€¦ not because they are easy, but because they are hard.â€" },
      { who:"Martin Luther King Jr.", text:"â€œFree at last! Free at last! Thank God Almighty, we are free at last!â€" },
      { who:"Ronald Reagan", text:"â€œMr. Gorbachev, tear down this wall!â€" }
    ];

    const QUOTES_GROUPS = [
      { who:"John F. Kennedy", text:"â€œVictory has a hundred fathers and defeat is an orphan.â€" },
      { who:"Andrew Carnegie", text:"â€œNo man will make a great leader who wants to do it all himself or get all the credit for doing it.â€" },
      { who:"Andrew Carnegie", text:"â€œTeamwork is the ability to work together toward a common visionâ€¦ It is the fuel that allows common people to attain uncommon results.â€" },
      { who:"Rudyard Kipling", text:"â€œIf you can meet with Triumph and Disaster / And treat those two impostors just the sameâ€¦â€" },
      { who:"Eleanor Roosevelt", text:"â€œYou have to accept whatever comes and the only important thing is that you meet it with courageâ€¦â€" },
      { who:"Nelson Mandela", text:"â€œI never lose. I either win or learn.â€" }
    ];

    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    /***********************
     * EVENTOS (PARCIAL)
     * Formato: "AÃ‘O|TÃTULO"
     * (Pega mÃ¡s abajo para llegar a 800)
     ***********************/
    const EVENT_LINES = [
      "-3000000|Primeras herramientas de piedra (PaleolÃ­tico)",
      "-10000|RevoluciÃ³n neolÃ­tica: agricultura y sedentarismo",
      "-3200|Escritura cuneiforme en Mesopotamia",
      "-3100|UnificaciÃ³n del Antiguo Egipto",
      "-2600|ConstrucciÃ³n de grandes pirÃ¡mides en Egipto (auge del Reino Antiguo)",
      "-2334|SargÃ³n de Acad funda el Imperio acadio",
      "-1754|CÃ³digo de Hammurabi",
      "-1200|Colapso de la Edad del Bronce en el MediterrÃ¡neo oriental",
      "-776|Primeros Juegos OlÃ­mpicos (tradicional)",
      "-753|FundaciÃ³n tradicional de Roma",
      "-509|Inicio de la RepÃºblica romana (tradicional)",
      "-490|Batalla de MaratÃ³n",
      "-480|Batalla de las TermÃ³pilas",
      "-431|Guerra del Peloponeso (inicio)",
      "-399|Muerte de SÃ³crates",
      "-336|Alejandro Magno asciende al trono",
      "-323|Muerte de Alejandro Magno",
      "-264|Primera Guerra PÃºnica (inicio)",
      "-218|Segunda Guerra PÃºnica (inicio)",
      "-216|Batalla de Cannas",
      "-202|Batalla de Zama",
      "-146|DestrucciÃ³n de Cartago",
      "-44|Asesinato de Julio CÃ©sar",
      "-27|Augusto inaugura el Principado",
      "64|Gran incendio de Roma",
      "79|ErupciÃ³n del Vesubio (Pompeya)",
      "313|Edicto de MilÃ¡n",
      "476|CaÃ­da del Imperio romano de Occidente (convencional)",
      "622|HÃ©gira (inicio del calendario islÃ¡mico)",
      "800|CoronaciÃ³n de Carlomagno",
      "1066|Conquista normanda de Inglaterra",
      "1096|Primera Cruzada (inicio)",
      "1215|Carta Magna",
      "1347|Peste Negra en Europa (expansiÃ³n)",
      "1453|CaÃ­da de Constantinopla",
      "1492|Llegada de ColÃ³n a AmÃ©rica",
      "1517|PublicaciÃ³n de las 95 tesis de MartÃ­n Lutero",
      "1521|CaÃ­da de TenochtitlÃ¡n",
      "1543|CopÃ©rnico publica 'De revolutionibus'",
      "1618|Guerra de los Treinta AÃ±os (inicio)",
      "1648|Paz de Westfalia",
      "1687|Newton publica 'Principia'",
      "1776|DeclaraciÃ³n de Independencia de EE.UU.",
      "1789|Comienzo de la RevoluciÃ³n francesa",
      "1815|Congreso de Viena",
      "1848|Oleada de revoluciones europeas",
      "1859|Darwin publica 'El origen de las especies'",
      "1861|Comienza la Guerra Civil estadounidense",
      "1868|RestauraciÃ³n Meiji (JapÃ³n)",
      "1871|UnificaciÃ³n de Alemania",
      "1914|Comienza la Primera Guerra Mundial",
      "1917|RevoluciÃ³n rusa (hito)",
      "1918|Armisticio de la Primera Guerra Mundial",
      "1929|Crack de 1929",
      "1939|Comienza la Segunda Guerra Mundial",
      "1945|Entrada en vigor de la ONU",
      "1948|DeclaraciÃ³n Universal de los Derechos Humanos",
      "1957|Sputnik 1 (inicio de la era espacial)",
      "1962|Crisis de los misiles de Cuba",
      "1969|Llegada a la Luna (Apollo 11)",
      "1986|Accidente nuclear de ChernÃ³bil",
      "1989|CaÃ­da del Muro de BerlÃ­n",
      "1991|DisoluciÃ³n de la UniÃ³n SoviÃ©tica",
      "2001|Atentados del 11 de septiembre",
      "2008|Crisis financiera global",
      "2020|Pandemia de COVID-19 (hito)",
      "2022|InvasiÃ³n rusa de Ucrania (escalada total)",
      "2023|PopularizaciÃ³n masiva de la IA generativa",
      "2026|Continuidad y regulaciÃ³n creciente de la IA (hito)"
      -9000|JericÃ³ se consolida como asentamiento urbano (aprox.)
-7000|Ã‡atalhÃ¶yÃ¼k alcanza gran desarrollo (aprox.)
-4000|Auge de Uruk y primeras ciudades mesopotÃ¡micas (aprox.)
-3500|InvenciÃ³n de la rueda en Mesopotamia (aprox.)
-3000|Primeras dinastÃ­as en Sumer (aprox.)
-2900|Inicio del Periodo DinÃ¡stico Arcaico sumerio (aprox.)
-2700|Epopeya de Gilgamesh (tradiciÃ³n temprana, aprox.)
-2550|Keops y la Gran PirÃ¡mide (aprox.)
-2500|Auge de la civilizaciÃ³n del Indo (Harappa/Mohenjo-Daro, aprox.)
-2300|Akkad en expansiÃ³n por Mesopotamia (aprox.)
-2100|Ur III: renacimiento sumerio (aprox.)
-2000|Inicio del Imperio Medio egipcio (aprox.)
-1900|CÃ³digo de Ur-Nammu (aprox.)
-1800|Auge de Babilonia antigua (aprox.)
-1700|Declive del Imperio Medio egipcio (aprox.)
-1650|Hicsos dominan el Delta del Nilo (aprox.)
-1500|Auge del Imperio hitita (aprox.)
-1500|ExpansiÃ³n del comercio micÃ©nico (aprox.)
-1400|Cartas de Amarna (diplomacia egipcia, aprox.)
-1274|Batalla de Kadesh
-1250|Guerra de Troya (tradicional, aprox.)
-1206|Reinado de RamsÃ©s III (aprox.)
-1180|Colapso de los hititas (aprox.)
-1100|Comienzo del periodo de los Jueces (Israel, aprox.)
-1050|MonarquÃ­a unificada en Israel (SaÃºl, aprox.)
-1000|Reinado de David (aprox.)
-970|Reinado de SalomÃ³n (aprox.)
-930|DivisiÃ³n del Reino de Israel y JudÃ¡ (aprox.)
-814|FundaciÃ³n tradicional de Cartago (otra cronologÃ­a)
-700|ExpansiÃ³n griega: colonizaciÃ³n del MediterrÃ¡neo (aprox.)
-621|Leyes de DracÃ³n (Atenas)
-508|Reformas de ClÃ­stenes (Atenas)
-500|Buda: consolidaciÃ³n del budismo temprano (aprox.)
-479|Victoria griega en Platea (Guerras MÃ©dicas)
-468|Esquilo muere (hito cultural clÃ¡sico)
-450|Ley de las Doce Tablas (Roma, aprox.)
-449|Paz de Calias (tradicional, aprox.)
-404|Derrota de Atenas en la Guerra del Peloponeso
-387|Academia de PlatÃ³n (consolidaciÃ³n, aprox.)
-356|Nacimiento de Alejandro Magno
-332|Alejandro conquista Egipto y funda AlejandrÃ­a (aprox.)
-301|Batalla de Ipsos
-280|Pirro invade Italia (hito)
-221|Qin Shi Huang unifica China
-210|ConstrucciÃ³n inicial de la Gran Muralla (Qin, aprox.)
-207|CaÃ­da de la dinastÃ­a Qin
-202|DinastÃ­a Han comienza (China)
-196|Piedra de Rosetta (hallazgo posterior; no usar)
-146|Roma destruye Corinto
-133|Roma hereda el reino de PÃ©rgamo (Asia Menor)
-73|RebeliÃ³n de Espartaco (inicio)
-63|Pompeyo toma JerusalÃ©n
-48|Batalla de Farsalia
-14|Muerte de Augusto
-43|InvasiÃ³n romana de Britania (Claudio)
-117|MÃ¡xima expansiÃ³n del Imperio romano (Trajano, aprox.)
-132|Revuelta de Bar Kojba (inicio)
-180|Muerte de Marco Aurelio
-193|AÃ±o de los Cinco Emperadores (Roma)
-235|Crisis del siglo III (inicio, aprox.)
-250|Persecuciones de Decio (hito)
-284|Diocleciano emperador (tetrarquÃ­a, inicio)
-303|Gran persecuciÃ³n de cristianos (inicio, aprox.)
-312|Batalla del Puente Milvio
-378|Batalla de AdrianÃ³polis
-406|Cruce del Rin por pueblos germÃ¡nicos (hito)
-455|Saqueo vÃ¡ndalo de Roma
-486|Clodoveo vence en Soissons (Francia, hito)
-496|ConversiÃ³n de Clodoveo al cristianismo (aprox.)
-529|FundaciÃ³n de Montecassino (Benedicto, aprox.)
-533|Reconquista de Ãfrica por Belisario (aprox.)
-537|Santa SofÃ­a consagrada
-568|InvasiÃ³n lombarda de Italia (inicio)
-590|Gregorio Magno papa (inicio)
-597|AgustÃ­n de Canterbury llega a Inglaterra (hito)
-602|Guerra bizantino-sasÃ¡nida (inicio)
-636|Batalla de Yarmuk
-637|Toma musulmana de JerusalÃ©n (aprox.)
-651|CaÃ­da del Imperio sasÃ¡nida (aprox.)
-680|Batalla de Karbala
-705|ExpansiÃ³n omeya en el Magreb (aprox.)
-718|Fracaso del asedio omeya de Constantinopla (aprox.)
-732|Batalla de Tours/Poitiers (ya NO estaba en tu lista: ojo, tÃº NO la tenÃ­as, pero la incluyo una vez)
-751|Batalla de Talas
-768|Carlomagno rey de los francos (inicio)
-793|Saqueo vikingo de Lindisfarne
-802|Imperio jemer: Jayavarman II (hito, aprox.)
-811|Batalla de Pliska (Bizancio vs bÃºlgaros, aprox.)
-843|Fin de la iconoclasia bizantina (Triunfo de la Ortodoxia)
-862|MisiÃ³n de Cirilo y Metodio (aprox.)
-871|Alfredo el Grande rey de Wessex (inicio)
-878|Tratado de Wedmore (Alfredo vs vikingos)
-907|DinastÃ­a Tang cae (China)
-911|FundaciÃ³n del Ducado de NormandÃ­a
-936|OtÃ³n I rey de Alemania (inicio)
-955|Batalla de Lechfeld
-988|CristianizaciÃ³n de la Rus de Kiev (VladÃ­mir)
-1007|FundaciÃ³n de la abadÃ­a de Cluny (consolidaciÃ³n, hito)
-1016|Canuto el Grande rey de Inglaterra (aprox.)
-1037|Fin del Califato de CÃ³rdoba (reinos de taifas, aprox.)
-1055|SelyÃºcidas toman Bagdad (aprox.)
-1077|Enrique IV en Canossa (hito)
-1085|Conquista cristiana de Toledo
-1100|ConsolidaciÃ³n del feudalismo europeo (aprox.)
-1119|FundaciÃ³n de los Templarios (aprox.)
-1139|Portugal reconocido (Tratado de Zamora, aprox.)
-1158|FundaciÃ³n de la Liga HanseÃ¡tica (hito temprano, aprox.)
-1176|Batalla de Legnano
-1189|Tercera Cruzada (inicio)
-1192|Fin de la Tercera Cruzada (tratado, hito)
-1209|Cruzada albigense (inicio)
-1212|Batalla de Las Navas de Tolosa
-1227|Muerte de Gengis Kan
-1236|Los mongoles toman Kiev (aprox.)
-1244|CaÃ­da de JerusalÃ©n ante jorezmitas (hito)
-1265|Parlamento modelo en Inglaterra (aprox.)
-1274|II Concilio de Lyon (hito)
-1279|DinastÃ­a Yuan consolida China (aprox.)
-1281|Segunda invasiÃ³n mongola de JapÃ³n (fracasa)
-1299|FundaciÃ³n del Imperio otomano (tradicional, aprox.)
-1302|Batalla de las Espuelas de Oro
-1309|Papado de AviÃ±Ã³n (inicio)
-1315|Gran hambruna europea (inicio, aprox.)
-1325|FundaciÃ³n de TenochtitlÃ¡n (tradicional)
-1381|Revuelta de los campesinos en Inglaterra
-1410|Batalla de Grunwald
-1419|DefenestraciÃ³n de Praga (inicio guerras husitas)
-1434|InvenciÃ³n/imprenta: avances europeos (hito temprano)
-1469|UniÃ³n dinÃ¡stica de Castilla y AragÃ³n (matrimonio)
-1478|Inicio de la InquisiciÃ³n espaÃ±ola (aprox.)
-1485|Batalla de Bosworth (fin Guerra de las Dos Rosas)
-1498|Vasco da Gama llega a la India
-1500|Cabral llega a Brasil
-1513|Maquiavelo escribe â€œEl PrÃ­ncipeâ€ (aprox.)
-1519|Inicio de la expediciÃ³n de Magallanes
-1532|Pizarro captura a Atahualpa
-1545|Concilio de Trento (inicio)
-1558|Isabel I reina en Inglaterra (inicio)
-1565|FundaciÃ³n de San AgustÃ­n (Florida, hito colonial)
-1568|Guerra de los Ochenta AÃ±os (inicio)
-1571|Batalla de Lepanto
-1589|Enrique IV inicia la dinastÃ­a BorbÃ³n (Francia, aprox.)
-1598|Edicto de Nantes
-1605|ConspiraciÃ³n de la pÃ³lvora (Inglaterra)
-1610|Asesinato de Enrique IV (Francia)
-1628|PeticiÃ³n de Derechos (Inglaterra)
-1633|Juicio de Galileo (hito)
-1652|FundaciÃ³n de Ciudad del Cabo (hito colonial neerlandÃ©s)
-1660|RestauraciÃ³n inglesa (Carlos II)
-1665|Gran peste de Londres
-1666|Gran incendio de Londres
-1679|Habeas Corpus Act (Inglaterra)
-1683|Sitio de Viena (derrota otomana)
-1688|RevoluciÃ³n Gloriosa (Inglaterra)
-1692|Juicios de Salem (hito)
-1701|Inicio de la Gran Guerra del Norte
-1703|FundaciÃ³n de San Petersburgo
-1707|Acta de UniÃ³n: Gran BretaÃ±a
-1715|Muerte de Luis XIV (hito)
-1721|Fin de la Gran Guerra del Norte (Nystad)
-1733|InvenciÃ³n del flying shuttle (hito textil)
-1740|Guerra de SucesiÃ³n austriaca (inicio)
-1751|PublicaciÃ³n de la Enciclopedia (inicio, aprox.)
-1760|Comienzo del reinado de Jorge III (hito)
-1763|Tratado de ParÃ­s (fin Guerra de los Siete AÃ±os)
-1769|Nacimiento de NapoleÃ³n Bonaparte
-1770|Masacre de Boston
-1773|MotÃ­n del tÃ© de Boston
-1775|Batallas de Lexington y Concord (inicio guerra)
-1783|Tratado de ParÃ­s (independencia de EE.UU.)
-1787|ConstituciÃ³n de EE.UU. (firma)
-1793|EjecuciÃ³n de Luis XVI
-1798|CampaÃ±a de Egipto de NapoleÃ³n (inicio)
-1807|AboliciÃ³n del comercio de esclavos (Reino Unido) (ya NO estaba como evento separado)
-1808|Levantamiento del Dos de Mayo (EspaÃ±a)
-1812|Guerra anglo-estadounidense de 1812 (inicio)
-1816|â€œAÃ±o sin veranoâ€ (Tambora, efectos climÃ¡ticos)
-1820|RevoluciÃ³n liberal en EspaÃ±a (Trienio, inicio)
-1823|Doctrina Monroe
-1831|RebeliÃ³n de Nat Turner (EE.UU.)
-1839|Primera Guerra del Opio (inicio)
-1845|Gran hambruna irlandesa (inicio)
-1846|Descubrimiento de Neptuno
-1857|RebeliÃ³n de los cipayos (India, inicio)
-1863|ProclamaciÃ³n de EmancipaciÃ³n (EE.UU., efectiva)
-1867|Compra de Alaska
-1869|Canal de Suez inaugurado
-1876|Batalla de Little Bighorn
-1886|Revuelta de Haymarket (hito laboral)
-1889|Torre Eiffel inaugurada
-1898|Guerra hispano-estadounidense (inicio)
-1900|RebeliÃ³n de los bÃ³xers (China, inicio)
-1901|FederaciÃ³n de Australia (hito)
-1911|RevoluciÃ³n china: caÃ­da de la dinastÃ­a Qing (aprox.)
-1912|Primera Guerra BalcÃ¡nica (inicio)
-1913|Segunda Guerra BalcÃ¡nica (hito)
-1915|Genocidio armenio (inicio, hito)
-1916|Batalla de VerdÃºn (inicio)
-1920|Sociedad de Naciones inicia actividad (aprox.)
-1921|ParticiÃ³n de Irlanda (hito)
-1923|RepÃºblica de TurquÃ­a proclamada
-1924|Muerte de Lenin
-1927|Primer largometraje sonoro popular (â€œThe Jazz Singerâ€)
-1932|Holodomor (Ucrania, inicio aprox.)
-1935|Leyes de NÃºremberg
-1940|Batalla de Inglaterra (inicio)
-1941|OperaciÃ³n Barbarroja (inicio)
-1942|Batalla de Stalingrado (inicio)
-1943|Conferencia de TeherÃ¡n
-1947|Plan Marshall (anuncio/inicio)
-1948|Bloqueo de BerlÃ­n (inicio)
-1949|Primera bomba atÃ³mica soviÃ©tica
-1950|Guerra de Corea (inicio)
-1953|Muerte de Stalin
-1955|Pacto de Varsovia
-1956|RevoluciÃ³n hÃºngara
-1956|Crisis de Suez
-1959|RevoluciÃ³n cubana (triunfo)
-1960|Independencias africanas: â€œAÃ±o de Ãfricaâ€ (hito)
-1963|Tratado de ProhibiciÃ³n Parcial de Pruebas Nucleares
-1967|Guerra de los Seis DÃ­as
-1968|Primavera de Praga
-1972|Acuerdos SALT I
-1973|Golpe de Estado en Chile
-1975|Fin de la Guerra de Vietnam (caÃ­da de SaigÃ³n)
-1978|Acuerdos de Camp David
-1979|InvasiÃ³n soviÃ©tica de AfganistÃ¡n (inicio)
-1981|Primer vuelo del transbordador espacial (Columbia)
-1983|Internet adopta TCP/IP (hito)
-1984|Bhopal: desastre industrial (hito)
-1994|Genocidio en Ruanda (hito)
-1995|Acuerdos de Dayton (Bosnia)
-1997|Entrega de Hong Kong a China
-1998|Acuerdo de Viernes Santo (Irlanda del Norte)
-2004|Tsunami del OcÃ©ano Ãndico
-2007|Lanzamiento del iPhone (hito tecnolÃ³gico)
-2010|Primavera Ãrabe (inicio, hito)
-2015|Acuerdo de ParÃ­s (clima)
-2021|Salida de EE.UU. de AfganistÃ¡n (hito)
-2024|Juegos OlÃ­mpicos de ParÃ­s (hito)
-2700|Primeras tablillas administrativas de escritura en Uruk (aprox.)
-2474|Reinado de Pepi II (Egipto, inicio aprox.)
-2350|Reformas de Urukagina en Lagash (aprox.)
-2210|Colapso del Imperio acadio (aprox.)
-2055|CÃ³digo de Lipit-Ishtar (aprox.)
-1792|Hammurabi asciende al trono de Babilonia (aprox.)
-1595|Saqueo hitita de Babilonia (aprox.)
-1323|Muerte de TutankamÃ³n (aprox.)
-1279|RamsÃ©s II asciende al trono (aprox.)
-1100|Inicio aproximado de la Edad del Hierro en Europa
-1000|Auge de los olmecas en MesoamÃ©rica (aprox.)
-900|TradiciÃ³n homÃ©rica se consolida en Grecia (aprox.)
-750|Reformas de Licurgo en Esparta (tradicional, aprox.)
-728|Tiglatpileser III consolida el Imperio asirio (aprox.)
-650|FundaciÃ³n de Cirene (colonia griega, aprox.)
-612|CaÃ­da de NÃ­nive
-586|DestrucciÃ³n del Primer Templo de JerusalÃ©n (aprox.)
-559|Ciro el Grande se convierte en rey de Persia (aprox.)
-550|FundaciÃ³n del Imperio aquemÃ©nida (aprox.)
-547|Ciro conquista Lidia (aprox.)
-539|Ciro toma Babilonia
-525|Conquista persa de Egipto (Cambises II)
-522|DarÃ­o I asciende al trono persa (aprox.)
-515|Segundo Templo de JerusalÃ©n terminado (aprox.)
-479|Batalla de MÃ­cala
-477|Liga de Delos fundada (aprox.)
-371|Batalla de Leuctra
-338|Batalla de Queronea
-321|Chandragupta Maurya funda el Imperio Maurya (aprox.)
-272|Ashoka se convierte en emperador Maurya (aprox.)
-250|ExpansiÃ³n del budismo bajo Ashoka (aprox.)
-238|Decreto de Canopo (Egipto ptolemaico, hito)
-229|Roma consolida su control sobre Iliria (hito)
-168|Batalla de Pidna
-112|Guerras cimbrias (inicio aprox.)
-52|VercingÃ©torix derrotado en Alesia
-19|Fin de las Guerras cÃ¡ntabras (conquista romana de Hispania, aprox.)
6|Judea pasa a control romano directo (aprox.)
122|Muro de Adriano (inicio construcciÃ³n, aprox.)
165|Peste antonina (inicio, aprox.)
251|Batalla de Abrito (Roma vs godos, hito)
260|Captura del emperador Valeriano por Persia (hito)
272|Reconquista de Palmira por Aureliano (aprox.)
312|Batalla del Puente Milvio
324|Constantino unifica el Imperio romano (aprox.)
418|Visigodos se establecen en Aquitania (hito)
429|VÃ¡ndalos cruzan a Ãfrica (inicio, aprox.)
493|Teodorico el Grande reina en Italia (inicio)
507|Batalla de VouillÃ© (francos vs visigodos)
529|CÃ³digo de Justiniano (Corpus Juris Civilis, inicio aprox.)
537|Santa SofÃ­a consagrada (otra formulaciÃ³n)
552|Batalla de Taginae (guerra gÃ³tica, hito)
568|InvasiÃ³n lombarda de Italia (otra formulaciÃ³n)
587|ConversiÃ³n de Recaredo (III Concilio de Toledo)
626|Asedio de Constantinopla por Ã¡varos y persas (aprox.)
670|FundaciÃ³n de KairuÃ¡n (aprox.)
705|Conquista omeya de Sind (inicio aprox.)
711|Batalla de Guadalete (aprox.)
787|II Concilio de Nicea (otra formulaciÃ³n)
830|Auge de la Casa de la SabidurÃ­a (Bagdad, aprox.)
972|CristianizaciÃ³n de Polonia (aprox.)
1014|Batalla de Clontarf
1059|Reforma papal: decreto sobre la elecciÃ³n del papa (hito)
1099|FundaciÃ³n del Reino de JerusalÃ©n (hito cruzado)
1109|Conquista cristiana de Zaragoza (aprox.)
1118|FundaciÃ³n de la Orden del Temple (otra cronologÃ­a)
1130|Roger II se corona rey de Sicilia (aprox.)
1170|Asesinato de Thomas Becket
1189|Ricardo CorazÃ³n de LeÃ³n rey (inicio, aprox.)
1198|Inocencio III papa (inicio, hito)
1260|Batalla de Ain Jalut (otra formulaciÃ³n no incluida antes)
1271|Shogunato Kamakura se consolida (aprox.)
1295|Marco Polo regresa a Venecia (aprox.)
1314|Batalla de Bannockburn
1320|DeclaraciÃ³n de Arbroath (Escocia, hito)
1348|La Peste Negra alcanza Inglaterra (aprox.)
1415|Portugal conquista Ceuta
1438|Imperio inca: ascenso de PachacÃºtec (aprox.)
1455|Inicio de la Guerra de las Dos Rosas (aprox.)
1471|Batalla de Tewkesbury (Guerra de las Dos Rosas)
1480|Saqueo otomano de Otranto (hito)
1498|Savonarola es ejecutado en Florencia
1509|Enrique VIII asciende al trono (Inglaterra)
1536|DisoluciÃ³n de los monasterios en Inglaterra (inicio, aprox.)
1556|AbdicaciÃ³n de Carlos V (aprox.)
1562|Guerras de religiÃ³n en Francia (inicio)
1572|Matanza de San BartolomÃ© (Francia)
1581|Acta de AbjuraciÃ³n (independencia neerlandesa de facto)
1603|Tokugawa Ieyasu establece el shogunato Tokugawa
1608|InvenciÃ³n del telescopio (hito)
1611|Biblia del Rey Jacobo publicada
1632|Comienza la construcciÃ³n del Taj Mahal (aprox.)
1637|RebeliÃ³n de Shimabara (JapÃ³n, aprox.)
1644|DinastÃ­a Qing toma PekÃ­n (aprox.)
1651|Hobbes publica 'LeviatÃ¡n'
1661|Luis XIV inicia el gobierno personal (aprox.)
1682|La corte francesa se instala en Versalles (aprox.)
1690|Batalla del Boyne
1709|Batalla de Poltava
1714|SucesiÃ³n hannoveriana en Gran BretaÃ±a (aprox.)
1739|Guerra del Asiento (Jenkins' Ear) (inicio)
1748|Tratado de AquisgrÃ¡n (fin Guerra de SucesiÃ³n austriaca)
1755|Terremoto de Lisboa
1762|Rousseau publica 'El contrato social'
1796|Jenner desarrolla la vacuna contra la viruela (hito)
1803|Compra de Luisiana
1805|Batalla de Trafalgar
1807|Fulton demuestra un barco de vapor comercial (hito)
1813|Batalla de Leipzig
1829|EmancipaciÃ³n catÃ³lica en el Reino Unido (hito)
1833|Ley de AboliciÃ³n de la Esclavitud en el Imperio britÃ¡nico
1838|MovilizaciÃ³n cartista en el Reino Unido (hito, aprox.)
1846|Guerra entre MÃ©xico y Estados Unidos (inicio)
1854|John Snow y el brote de cÃ³lera en Londres (hito)
1858|Inicio del Raj britÃ¡nico en India
1866|Mendel presenta sus leyes de la herencia (hito)
1883|ErupciÃ³n del Krakatoa
1895|RÃ¶ntgen descubre los rayos X
1905|Einstein publica la relatividad especial (hito)
1908|Ford Model T entra en producciÃ³n (hito)
1910|RevoluciÃ³n mexicana (inicio)
1928|Fleming descubre la penicilina
1937|Masacre de NankÃ­n (inicio, aprox.)
1940|EvacuaciÃ³n de Dunkerque (hito)
1947|Independencia de PakistÃ¡n (hito)
1958|NASA se funda (hito)
1964|Ley de Derechos Civiles en EE.UU. (hito)
1965|Independencia de Singapur (hito)
1974|DimisiÃ³n de Nixon (Watergate, hito)
1980|Sindicato Solidaridad surge en Polonia (hito)
1982|Guerra de las Malvinas (inicio)
1990|ReunificaciÃ³n de Alemania (hito)
1993|Tratado de Maastricht entra en vigor (UniÃ³n Europea, hito)
1997|Protocolo de Kioto (adopciÃ³n, hito)
2003|Se completa el Proyecto Genoma Humano (hito)
2011|Accidente nuclear de Fukushima (hito)
2012|Anuncio del bosÃ³n de Higgs (hito)
2019|Primera imagen de un agujero negro (hito)
1830|Independencia de BÃ©lgica (hito)
1904|Guerra ruso-japonesa (inicio)
2002|El euro entra en circulaciÃ³n como moneda fÃ­sica (hito)
      // â† PEGA MÃS AQUÃ (AÃ‘O|TÃTULO)
    ];

    function parseEvents(lines){
      const out = [];
      const seen = new Set();
      for(const line of lines){
        const s = String(line);
        if(!s.includes("|")) continue;
        const [yRaw, ...rest] = s.split("|");
        const year = Number(yRaw.trim());
        const title = rest.join("|").trim();
        if(!Number.isFinite(year) || !title) continue;
        const key = year + "|" + title.toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        out.push({ id: "e"+out.length, year, title });
      }
      return out;
    }
    const ALL_EVENTS = parseEvents(EVENT_LINES);

    /***********************
     * HELPERS
     ***********************/
    const $ = (sel)=>document.querySelector(sel);
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    /***********************
     * STATE
     ***********************/
    const btnStart = $("#btnStart");
    const btnSettings = $("#btnSettings");
    const backdrop = $("#backdrop");
    const btnClose = $("#btnClose");
    const btnSave = $("#btnSave");
    const btnReset = $("#btnReset");

    const modeSolo = $("#modeSolo");
    const modeGroups = $("#modeGroups");
    const perScreenSel = $("#perScreen");
    const roundsSel = $("#rounds");
    const difficultySel = $("#difficulty");
    const groupsBox = $("#groupsBox");
    const groupsTa = $("#groups");

    const game = $("#game");
    const cardList = $("#cardList");
    const whoLine = $("#whoLine");
    const btnCheck = $("#btnCheck");
    const btnNext = $("#btnNext");

    const roundPill = $("#roundPill");
    const roundBarFill = $("#roundBarFill");

    const popup = $("#popup");
    const popupTitle = $("#popupTitle");
    const popupText = $("#popupText");
    const popupScores = $("#popupScores");
    const btnPopupClose = $("#btnPopupClose");

    let draggedEl = null;

    const state = {
      mode: "solo",
      perScreen: 5,
      rounds: 8,
      difficulty: "normal",
      groups: ["Grupo 1","Grupo 2"],

      currentGroupIdx: 0,
      screenIndex: 1,

      scoreByGroup: {},
      correctTotal: 0,
      wrongTotal: 0,

      usedIds: new Set(),
      locked: false,

      currentRoundEvents: [],
      correctOrder: [],

      // tie-break
      tieBreakActive: false,
      tieWinners: [],
      tieScores: {},
      tieRound: 0
    };

    function saveSettings(){
      localStorage.setItem("hist_sort_settings_full", JSON.stringify({
        mode: state.mode,
        perScreen: state.perScreen,
        rounds: state.rounds,
        difficulty: state.difficulty,
        groups: state.groups
      }));
    }
    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem("hist_sort_settings_full") || "{}");
        if(s.mode) state.mode = s.mode;
        if(s.perScreen) state.perScreen = clamp(+s.perScreen, 4, 8);
        if(s.rounds) state.rounds = clamp(+s.rounds, 1, 50);
        if(s.difficulty) state.difficulty = s.difficulty;
        if(Array.isArray(s.groups) && s.groups.length >= 2){
          state.groups = s.groups.map(x=>String(x).trim()).filter(Boolean).slice(0,12);
        }
      }catch(_){}
    }

    function resetGame(){
      state.currentGroupIdx = 0;
      state.screenIndex = 1;
      state.scoreByGroup = {};
      state.correctTotal = 0;
      state.wrongTotal = 0;
      state.usedIds = new Set();
      state.locked = false;

      state.tieBreakActive = false;
      state.tieWinners = [];
      state.tieScores = {};
      state.tieRound = 0;

      if(state.mode === "groups"){
        for(const g of state.groups) state.scoreByGroup[g] = 0;
      }

      game.style.display = "none";
      btnNext.disabled = true;
      btnCheck.disabled = false;
    }

    function totalScreens(){
      if(state.tieBreakActive) return 1;
      return (state.mode === "solo") ? state.rounds : state.rounds * state.groups.length;
    }

    function getRoundProgress(){
      if(state.tieBreakActive){
        return { label: "Desempate", pct: 100 };
      }
      if(state.mode === "solo"){
        const r = state.screenIndex;
        const total = state.rounds;
        const pct = total ? Math.round((r/total)*100) : 0;
        return { label: `Ronda ${r}/${total}`, pct };
      }
      const r = Math.ceil(state.screenIndex / state.groups.length);
      const total = state.rounds;
      const pct = total ? Math.round((r/total)*100) : 0;
      return { label: `Ronda ${r}/${total}`, pct };
    }

    function currentGroupName(){
      if(state.tieBreakActive) return state.tieWinners[state.currentGroupIdx] || "Desempate";
      return (state.mode === "groups") ? state.groups[state.currentGroupIdx] : "Solo";
    }

    function attachDnD(el){
      el.addEventListener("dragstart", (e)=>{
        if(state.locked) return e.preventDefault();
        draggedEl = el;
        el.classList.add("ghost");
        e.dataTransfer.effectAllowed = "move";
      });
      el.addEventListener("dragend", ()=>{
        if(draggedEl) draggedEl.classList.remove("ghost");
        draggedEl = null;
      });
      el.addEventListener("dragover", (e)=>{
        if(state.locked) return;
        e.preventDefault();
        const target = el;
        if(!draggedEl || target === draggedEl) return;
        const rect = target.getBoundingClientRect();
        const next = (e.clientY - rect.top) > (rect.height/2);
        cardList.insertBefore(draggedEl, next ? target.nextSibling : target);
      });
      el.addEventListener("drop", (e)=>{
        if(state.locked) return;
        e.preventDefault();
      });
    }

    function pickRoundEvents(want){
      let pool = ALL_EVENTS.filter(e => !state.usedIds.has(e.id));
      if(pool.length < want){
        state.usedIds.clear();
        pool = ALL_EVENTS.slice();
      }

      let chosen = [];
      const hardish = (state.difficulty === "hard") || state.tieBreakActive || want === 3;

      if(hardish){
        // "difÃ­ciles": aÃ±os cercanos entre sÃ­
        const sorted = pool.slice().sort((a,b)=>a.year-b.year);
        const idx = Math.floor(Math.random()*sorted.length);
        const base = sorted[idx].year;
        const window = sorted.filter(e=>Math.abs(e.year-base) <= 25);
        const src = (window.length >= want) ? window : sorted;

        while(chosen.length < want){
          chosen.push(src[Math.floor(Math.random()*src.length)]);
        }
      } else {
        while(chosen.length < want){
          chosen.push(pool[Math.floor(Math.random()*pool.length)]);
        }
      }

      // unique + mark used
      const uniq = [];
      const seen = new Set();
      for(const e of chosen){
        if(seen.has(e.id)) continue;
        seen.add(e.id);
        uniq.push(e);
        state.usedIds.add(e.id);
      }
      while(uniq.length < want){
        const e = pool[Math.floor(Math.random()*pool.length)];
        if(seen.has(e.id)) continue;
        seen.add(e.id);
        uniq.push(e);
        state.usedIds.add(e.id);
      }
      return uniq;
    }

    function renderRound(){
      state.locked = false;
      btnCheck.disabled = false;
      btnNext.disabled = true;

      const want = state.tieBreakActive ? 3 : state.perScreen;

      state.currentRoundEvents = pickRoundEvents(want);
      state.correctOrder = state.currentRoundEvents.slice().sort((a,b)=>a.year-b.year);

      const shown = shuffle(state.currentRoundEvents);

      cardList.innerHTML = "";
      for(const ev of shown){
        const li = document.createElement("li");
        li.className = "card";
        li.draggable = true;
        li.dataset.id = ev.id;

        // IMPORTANT: no year shown until check
        li.innerHTML = `
          <div class="handle">â‹®â‹®</div>
          <div>
            <p class="title">${escapeHtml(ev.title)}</p>
            <p class="meta"></p>
          </div>
        `;
        attachDnD(li);
        cardList.appendChild(li);
      }

      const who = currentGroupName();
      const total = totalScreens();
      const prefix = state.tieBreakActive ? "Desempate" : "Pantalla";
      const index = state.tieBreakActive ? 1 : state.screenIndex;

      whoLine.innerHTML = `Turno: <b>${escapeHtml(who)}</b> Â· ${prefix} <b>${index}</b> / <b>${total}</b>`;

      const prog = getRoundProgress();
      roundPill.textContent = prog.label;
      roundBarFill.style.width = `${prog.pct}%`;
    }

    function getOrderIds(){
      return [...cardList.querySelectorAll(".card")].map(x=>x.dataset.id);
    }

    function checkRound(){
      if(state.locked) return;
      state.locked = true;
      btnCheck.disabled = true;

      // score computed with the order before revealing years
      const ids = getOrderIds();
      const correctIds = state.correctOrder.map(e=>e.id);

      let correct = 0;
      const cards = [...cardList.querySelectorAll(".card")];

      cards.forEach((card, idx)=>{
        const ok = ids[idx] === correctIds[idx];
        card.style.borderColor = ok ? "rgba(214,178,94,.65)" : "rgba(255,120,150,.55)";
        card.style.background = ok ? "rgba(214,178,94,.10)" : "rgba(255,120,150,.08)";
        card.classList.add("locked");
        card.draggable = false;
        if(ok) correct++;
      });

      const wrong = cards.length - correct;

      if(state.tieBreakActive){
        const g = currentGroupName();
        state.tieScores[g] = (state.tieScores[g] || 0) + correct;
      } else if(state.mode === "groups"){
        const g = currentGroupName();
        state.scoreByGroup[g] = (state.scoreByGroup[g] || 0) + correct;
      } else {
        state.correctTotal += correct;
        state.wrongTotal += wrong;
      }

      // Reveal years now
      cards.forEach((card)=>{
        const id = card.dataset.id;
        const ev = state.currentRoundEvents.find(e=>e.id===id);
        const meta = card.querySelector(".meta");
        if(ev && meta) meta.textContent = `AÃ±o: ${ev.year}`;
      });

      btnNext.disabled = false;
    }

    function nextScreen(){
      if(state.tieBreakActive){
        resolveTieBreakStep();
        return;
      }

      const total = totalScreens();
      if(state.screenIndex >= total){
        endGame();
        return;
      }

      state.screenIndex += 1;
      if(state.mode === "groups"){
        state.currentGroupIdx = (state.currentGroupIdx + 1) % state.groups.length;
      }
      renderRound();
    }

    function startTieBreak(winners){
      state.tieBreakActive = true;
      state.tieWinners = winners.slice();
      state.tieScores = {};
      for(const g of state.tieWinners) state.tieScores[g] = 0;
      state.tieRound = 1;
      state.currentGroupIdx = 0;

      renderRound();
    }

    function resolveTieBreakStep(){
      // each tied group plays one turn. When last finishes, evaluate.
      if(state.currentGroupIdx < state.tieWinners.length - 1){
        state.currentGroupIdx += 1;
        renderRound();
        return;
      }

      const entries = Object.entries(state.tieScores).sort((a,b)=>b[1]-a[1]);
      const top = entries[0]?.[1] ?? 0;
      const tied = entries.filter(x=>x[1]===top).map(x=>x[0]);

      if(tied.length === 1){
        state.tieBreakActive = false;

        const q = pickRandom(QUOTES_GROUPS);
        popupTitle.textContent = "ðŸ† Ganador";
        popupText.textContent = `${tied[0]} gana el desempate.\n\n${q.text} â€” ${q.who}`;
        popupScores.style.display = "block";
        popupScores.textContent = entries.map(([g,sc])=>`${g}: ${sc} puntos`).join("\n");
        popup.style.display = "flex";
        return;
      }

      // still tied: repeat with new hard set
      state.tieWinners = tied;
      state.tieScores = {};
      for(const g of state.tieWinners) state.tieScores[g] = 0;
      state.tieRound += 1;
      state.currentGroupIdx = 0;
      renderRound();
    }

    function endGame(){
      popupScores.style.display = "none";

      if(state.mode === "groups"){
        const entries = Object.entries(state.scoreByGroup).sort((a,b)=>b[1]-a[1]);
        const topScore = entries[0]?.[1] ?? 0;
        const winners = entries.filter(x=>x[1]===topScore).map(x=>x[0]);

        if(winners.length > 1){
          startTieBreak(winners);
          return;
        }

        const q = pickRandom(QUOTES_GROUPS);
        popupTitle.textContent = "ðŸ† Ganador";
        popupText.textContent = `${winners[0]} gana con ${topScore} puntos.\n\n${q.text} â€” ${q.who}`;
        popupScores.style.display = "block";
        popupScores.textContent = entries.map(([g,sc])=>`${g}: ${sc} puntos`).join("\n");
        popup.style.display = "flex";
        return;
      }

      // solo
      const total = state.correctTotal + state.wrongTotal;
      const perfect = (state.wrongTotal === 0);

      if(perfect){
        const q = pickRandom(QUOTES_VICTORY);
        popupTitle.textContent = "ðŸ§  Genio de la historia";
        popupText.textContent = `Has acertado TODO: ${state.correctTotal}/${total}.\n\n${q.text} â€” ${q.who}`;
      } else {
        const q = pickRandom(QUOTES_KEEP_GOING);
        popupTitle.textContent = "Fin";
        popupText.textContent = `Aciertos: ${state.correctTotal}/${total} Â· Fallos: ${state.wrongTotal}.\n\n${q.text} â€” ${q.who}`;
      }
      popup.style.display = "flex";
    }

    function startGame(){
      game.style.display = "block";
      renderRound();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showSettings(){
      modeSolo.classList.toggle("active", state.mode==="solo");
      modeGroups.classList.toggle("active", state.mode==="groups");
      perScreenSel.value = String(state.perScreen);
      roundsSel.value = String(state.rounds);
      difficultySel.value = state.difficulty;
      groupsTa.value = (state.groups || []).join("\n");
      groupsBox.style.display = (state.mode === "groups") ? "" : "none";
      backdrop.style.display = "flex";
    }
    function hideSettings(){ backdrop.style.display = "none"; }

    /***********************
     * UI events
     ***********************/
    btnStart.addEventListener("click", startGame);

    btnSettings.addEventListener("click", showSettings);
    btnClose.addEventListener("click", hideSettings);
    backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) hideSettings(); });

    modeSolo.addEventListener("click", ()=>{
      state.mode = "solo";
      modeSolo.classList.add("active");
      modeGroups.classList.remove("active");
      groupsBox.style.display = "none";
    });
    modeGroups.addEventListener("click", ()=>{
      state.mode = "groups";
      modeGroups.classList.add("active");
      modeSolo.classList.remove("active");
      groupsBox.style.display = "";
    });

    btnSave.addEventListener("click", ()=>{
      state.perScreen = clamp(parseInt(perScreenSel.value,10), 4, 8);
      state.rounds = clamp(parseInt(roundsSel.value,10), 1, 50);
      state.difficulty = String(difficultySel.value || "normal");

      if(state.mode === "groups"){
        const gs = String(groupsTa.value||"")
          .split("\n").map(s=>s.trim()).filter(Boolean)
          .slice(0, 12);
        state.groups = (gs.length >= 2) ? gs : ["Grupo 1","Grupo 2"];
      } else {
        state.groups = ["Solo"];
      }

      saveSettings();
      resetGame();
      hideSettings();
    });

    btnReset.addEventListener("click", ()=>{
      resetGame();
      hideSettings();
    });

    btnCheck.addEventListener("click", checkRound);
    btnNext.addEventListener("click", nextScreen);

    btnPopupClose.addEventListener("click", ()=>{
      popup.style.display = "none";
      resetGame();
    });

    (function init(){
      loadSettings();

      // apply to settings UI
      perScreenSel.value = String(state.perScreen);
      roundsSel.value = String(state.rounds);
      difficultySel.value = state.difficulty;
      modeSolo.classList.toggle("active", state.mode==="solo");
      modeGroups.classList.toggle("active", state.mode==="groups");
      groupsBox.style.display = (state.mode==="groups") ? "" : "none";
      groupsTa.value = (state.groups || []).join("\n");

      resetGame();
    })();
  </script>
</body>
</html>
